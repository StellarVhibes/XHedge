name: Protocol Liaison (XHedge Reviewer)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number to review'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  review:
    if: false
    name: XHedge Protocol Review
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ env.PR_NUMBER }}/head
          fetch-depth: 0

      - name: Setup Node & Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Review Protocol (SmartContract & Frontend)
        id: protocol_review
        continue-on-error: true
        run: |
          echo "Auditing Smart Contracts..."
          cd smartcontract && cargo test --all && cargo build --target wasm32-unknown-unknown --release
          cd ..
          echo "Auditing Frontend Dashboard..."
          cd frontend && npm install && npm run build

      - name: ❌ Handle Review Failure
        if: steps.protocol_review.outcome == 'failure'
        run: |
          echo "### ❌ Institutional Review Required"
          echo "Inconsistencies were found in the protocol logic or structural build."
          exit 1

      - name: ✅ Handle Review Success
        if: steps.protocol_review.outcome == 'success'
        run: |
          echo "### ✅ Review Successful"
          echo "The structural and logic integrity of both the Contracts and the Dashboard has been verified."
          echo "Status: Ready for Integration."
